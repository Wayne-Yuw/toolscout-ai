# ToolScout AI - 用户认证与会员系统设计

## 📋 文档信息

| 项目名称 | ToolScout AI - 用户认证与会员系统 |
|---------|--------------------------------|
| 版本号 | v1.0 |
| 编写日期 | 2025-11-07 |
| 文档状态 | 设计中 |

---

## 🎯 系统设计目标

### 核心原则
1. **手机号为唯一身份凭证** - 所有账号体系以手机号为核心
2. **多种登录方式** - 支持用户名密码、第三方OAuth(Google、GitHub)
3. **第三方账号必须绑定手机号** - 确保账号可追溯和可管理
4. **会员分级体系** - 支持免费、基础、高级、企业多个等级
5. **灵活的权限控制** - 基于会员等级的功能访问控制

---

## 📱 用户认证系统设计

### 1. 认证方式架构

```
┌─────────────────────────────────────────────────────────┐
│                    用户认证入口                           │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ 用户名密码    │  │  Google      │  │   GitHub     │ │
│  │   登录       │  │   OAuth      │  │   OAuth      │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│         │                  │                  │         │
│         └──────────────────┼──────────────────┘         │
│                            ▼                             │
│                 ┌─────────────────────┐                 │
│                 │  手机号验证/绑定     │                 │
│                 └─────────────────────┘                 │
│                            ▼                             │
│                 ┌─────────────────────┐                 │
│                 │   创建/更新用户      │                 │
│                 └─────────────────────┘                 │
│                            ▼                             │
│                 ┌─────────────────────┐                 │
│                 │   生成 JWT Token     │                 │
│                 └─────────────────────┘                 │
└─────────────────────────────────────────────────────────┘
```

### 2. 注册流程设计

#### 2.1 用户名密码注册

```
用户操作                    系统处理                    验证规则
─────────────────────────────────────────────────────────────
1. 输入手机号           → 检查手机号格式            ✓ 11位数字
                       → 检查是否已注册            ✓ 唯一性

2. 发送验证码           → 生成6位随机验证码         ✓ 60秒内有效
                       → 调用短信服务              ✓ 同一手机号1分钟内只能发1次
                       → 存储到Redis(60s过期)     ✓ 一天最多发送5次

3. 输入验证码           → 验证码校验                ✓ 验证码正确
                       → 标记手机号已验证          ✓ 在有效期内

4. 设置用户名           → 检查用户名格式            ✓ 3-20字符
                       → 检查用户名唯一性          ✓ 字母数字下划线

5. 设置密码             → 密码强度校验              ✓ 8-32字符
                       → 密码加密(bcrypt)          ✓ 包含大小写+数字

6. 创建账号             → 写入用户表                ✓ 初始化会员等级为免费
                       → 生成JWT Token             ✓ Token有效期7天
                       → 返回用户信息
```

#### 2.2 第三方OAuth注册流程

```
用户操作                    系统处理                    特殊处理
─────────────────────────────────────────────────────────────
1. 点击Google/GitHub   → 跳转到OAuth授权页面
   登录按钮

2. 授权成功             → 获取OAuth用户信息         ✓ email, name, avatar
                       → 检查email是否已绑定        ✓ 查询oauth_bindings表

3. 新用户流程:
   a. 显示手机号绑定页面 → 要求输入手机号            ✓ 必须绑定才能完成注册
   b. 发送验证码         → 同手机号注册流程
   c. 验证码校验         → 验证通过
   d. 创建账号           → 创建用户记录              ✓ 同时创建oauth_bindings记录
                       → 关联OAuth信息             ✓ provider: google/github
                                                   ✓ provider_user_id

4. 老用户流程:
   a. 已绑定手机号       → 直接登录                  ✓ 通过oauth_bindings查找用户
   b. 未绑定手机号       → 要求绑定手机号            ✓ 强制绑定流程
```

### 3. 登录流程设计

#### 3.1 用户名密码登录

```
步骤                     处理逻辑                     安全措施
─────────────────────────────────────────────────────────────
1. 输入用户名/手机号    → 查询用户记录               ✓ 统一查询接口
   + 密码

2. 验证密码             → bcrypt验证                 ✓ 密码错误次数限制(5次/小时)
                                                    ✓ 超过限制锁定账号30分钟

3. 生成Token            → 生成JWT(包含user_id,      ✓ Token过期时间7天
                          membership_level)         ✓ 支持刷新Token

4. 记录登录日志         → 写入login_logs表          ✓ IP地址
                                                    ✓ 设备信息
                                                    ✓ 登录时间
```

#### 3.2 第三方OAuth登录

```
步骤                     处理逻辑                     安全措施
─────────────────────────────────────────────────────────────
1. OAuth授权            → 获取授权码                 ✓ CSRF防护(state参数)

2. 获取用户信息         → 查询oauth_bindings表       ✓ 验证OAuth token有效性

3. 已绑定账号:          → 直接登录
   - 生成Token
   - 返回用户信息

4. 未绑定账号:          → 引导绑定手机号             ✓ 必须完成绑定才能使用
   - 显示绑定页面
   - 完成绑定流程
```

### 4. 手机号绑定/更换机制

#### 4.1 首次绑定(OAuth用户)

```
步骤                     验证规则
─────────────────────────────────────────
1. 输入手机号           ✓ 格式验证
                       ✓ 不能是已被其他账号绑定的手机号

2. 发送验证码           ✓ 短信发送限制

3. 验证码校验           ✓ 60秒内有效

4. 绑定成功             ✓ 更新用户表phone字段
                       ✓ 标记phone_verified=true
```

#### 4.2 更换手机号

```
步骤                     验证规则                     安全措施
─────────────────────────────────────────────────────────────
1. 验证旧手机号         → 发送验证码到旧手机号       ✓ 必须先验证旧手机号

2. 输入新手机号         → 格式验证                  ✓ 不能与其他账号重复

3. 验证新手机号         → 发送验证码到新手机号       ✓ 必须验证新手机号

4. 更新手机号           → 更新数据库                ✓ 记录更换历史
                       → 记录phone_change_logs表   ✓ 30天内只能更换1次
```

### 5. 密码管理

#### 5.1 密码重置

```
步骤                     处理流程
─────────────────────────────────────────
1. 输入手机号           → 查询用户是否存在

2. 发送验证码           → 短信验证码

3. 验证码校验           → 验证通过

4. 设置新密码           → 密码强度校验
                       → bcrypt加密
                       → 更新数据库
                       → 清除所有已登录Token(强制重新登录)
```

#### 5.2 密码修改(已登录)

```
步骤                     验证规则
─────────────────────────────────────────
1. 输入旧密码           ✓ 必须验证旧密码正确

2. 输入新密码           ✓ 新密码不能与旧密码相同
                       ✓ 密码强度校验

3. 确认新密码           ✓ 两次输入一致

4. 更新密码             ✓ 更新数据库
                       ✓ 记录密码修改日志
```

---

## 💎 会员订阅系统设计

### 1. 会员等级体系

```
等级         价格/月    核心权益                           配额限制
─────────────────────────────────────────────────────────────────
免费版      ¥0        • 每日3次工具分析                   • 3次/天分析
Free                  • 基础人群拆解(3个角度)              • 3个人群角度
                      • 1种文案风格                       • 1个文案风格
                      • 历史记录保留7天                    • 保留7天
                      • 带水印导出                        • 仅Markdown导出

─────────────────────────────────────────────────────────────────
基础版      ¥29/月    • 每日20次工具分析                  • 20次/天分析
Basic                 • 完整人群拆解(8个角度)              • 8个人群角度
                      • 4种预设文案风格                    • 4个预设风格
                      • 历史记录保留30天                   • 保留30天
                      • 无水印导出(MD/Word/PDF)          • 3种格式导出
                      • 邮件支持

─────────────────────────────────────────────────────────────────
专业版      ¥99/月    • 无限次工具分析                    • 不限次数
Pro                   • AI深度分析(竞品对比)              • 不限角度
                      • 所有文案风格+自定义风格            • 自定义风格
                      • 历史记录永久保存                   • 永久保存
                      • 所有格式导出                      • 5种格式
                      • API调用权限(1000次/月)            • 1000次API调用
                      • 优先客服支持

─────────────────────────────────────────────────────────────────
企业版      ¥499/月   • 专业版所有权益                    • 多用户(5个席位)
Enterprise            • 团队协作(5个席位)                 • 不限次数
                      • API调用(10000次/月)              • 10000次API调用
                      • 专属客户经理                      • 私有化部署选项
                      • 定制化开发支持                    • SLA保障
                      • 数据安全协议
```

### 2. 订阅购买流程

```
用户操作                    系统处理                    支付对接
─────────────────────────────────────────────────────────────────
1. 选择会员套餐         → 展示套餐详情               • 月付/年付选项
   (基础/专业/企业)     → 计算价格                  • 年付享8折优惠

2. 选择支付方式         → 跳转支付页面               • 微信支付
                                                    • 支付宝
                                                    • PayPal(国际)

3. 完成支付             → 接收支付回调               • 验证支付签名
                       → 更新用户会员等级            • 更新membership表
                       → 记录订单信息               • 创建订单记录
                       → 发送开通通知邮件

4. 自动续费(可选)       → 到期前3天发送提醒          • 自动扣费
                       → 自动续费                  • 扣费失败3次后降级
                       → 续费成功通知
```

### 3. 会员权益实时校验

```python
# 伪代码:权益校验逻辑

def check_analysis_quota(user_id):
    """检查工具分析配额"""
    user = get_user(user_id)
    membership = user.membership_level

    # 获取今日已使用次数
    today_count = get_today_analysis_count(user_id)

    # 配额限制
    quota_limits = {
        'free': 3,
        'basic': 20,
        'pro': float('inf'),    # 无限
        'enterprise': float('inf')
    }

    limit = quota_limits.get(membership, 3)

    if today_count >= limit:
        raise QuotaExceededError(
            f"今日分析次数已达上限({limit}次),请升级会员"
        )

    return True

def check_feature_access(user_id, feature):
    """检查功能访问权限"""
    user = get_user(user_id)
    membership = user.membership_level

    # 功能权限矩阵
    feature_matrix = {
        'custom_style': ['pro', 'enterprise'],
        'api_access': ['pro', 'enterprise'],
        'team_collaboration': ['enterprise'],
        'unlimited_export': ['pro', 'enterprise']
    }

    allowed_levels = feature_matrix.get(feature, [])

    if membership not in allowed_levels:
        raise PermissionDeniedError(
            f"该功能需要{','.join(allowed_levels)}会员"
        )

    return True
```

### 4. 会员到期处理

```
到期时间              处理动作                     通知方式
─────────────────────────────────────────────────────────────
到期前7天          → 发送续费提醒                • 站内通知
                                               • 邮件通知

到期前3天          → 再次提醒                    • 站内通知
                  → 如开启自动续费,预扣费        • 邮件通知
                                               • 短信通知

到期当天          → 会员等级降为免费             • 功能限制生效
                  → 历史数据保留(不删除)         • 导出功能受限
                  → 发送到期通知                • 提示升级

到期后30天        → 基础版/专业版历史数据       • 最后提醒
                    保留期满                   • 数据即将清理
                  → 发送数据导出提醒
```

---

## 🔐 数据库设计

### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    -- 基本信息
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名(唯一)',
    phone VARCHAR(20) UNIQUE NOT NULL COMMENT '手机号(唯一身份凭证)',
    phone_verified BOOLEAN DEFAULT FALSE COMMENT '手机号是否已验证',
    email VARCHAR(100) COMMENT '邮箱(可选)',
    email_verified BOOLEAN DEFAULT FALSE COMMENT '邮箱是否已验证',

    -- 密码相关
    password_hash VARCHAR(255) COMMENT '密码哈希(bcrypt)',
    password_salt VARCHAR(100) COMMENT '密码盐值',

    -- 用户资料
    nickname VARCHAR(50) COMMENT '昵称',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    bio TEXT COMMENT '个人简介',

    -- 会员信息
    membership_level ENUM('free', 'basic', 'pro', 'enterprise') DEFAULT 'free',
    membership_expire_at DATETIME COMMENT '会员到期时间',
    auto_renew BOOLEAN DEFAULT FALSE COMMENT '是否自动续费',

    -- 统计信息
    total_analysis_count INT DEFAULT 0 COMMENT '累计分析次数',
    total_script_count INT DEFAULT 0 COMMENT '累计生成文案数',

    -- 状态
    status ENUM('active', 'suspended', 'deleted') DEFAULT 'active',
    is_admin BOOLEAN DEFAULT FALSE COMMENT '是否是管理员',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP COMMENT '最后登录时间',

    INDEX idx_phone (phone),
    INDEX idx_username (username),
    INDEX idx_membership (membership_level, membership_expire_at),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

### 2. OAuth绑定表 (oauth_bindings)

```sql
CREATE TABLE oauth_bindings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    user_id BIGINT NOT NULL COMMENT '关联用户ID',

    -- OAuth信息
    provider ENUM('google', 'github') NOT NULL COMMENT 'OAuth提供商',
    provider_user_id VARCHAR(255) NOT NULL COMMENT '第三方平台用户ID',
    provider_username VARCHAR(100) COMMENT '第三方平台用户名',
    provider_email VARCHAR(100) COMMENT '第三方平台邮箱',
    provider_avatar VARCHAR(500) COMMENT '第三方平台头像',

    -- Token信息(用于刷新)
    access_token TEXT COMMENT '访问令牌',
    refresh_token TEXT COMMENT '刷新令牌',
    token_expires_at TIMESTAMP COMMENT '令牌过期时间',

    -- 元数据
    raw_data JSON COMMENT '原始OAuth返回数据',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP COMMENT '最后使用时间',

    UNIQUE KEY uk_provider_user (provider, provider_user_id),
    INDEX idx_user_id (user_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='OAuth绑定表';
```

### 3. 会员订阅表 (subscriptions)

```sql
CREATE TABLE subscriptions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 订阅信息
    plan_type ENUM('basic', 'pro', 'enterprise') NOT NULL COMMENT '套餐类型',
    billing_cycle ENUM('monthly', 'yearly') NOT NULL COMMENT '计费周期',

    -- 价格信息
    original_price DECIMAL(10,2) NOT NULL COMMENT '原价',
    paid_price DECIMAL(10,2) NOT NULL COMMENT '实付价格',
    discount_code VARCHAR(50) COMMENT '优惠码',

    -- 订阅周期
    started_at TIMESTAMP NOT NULL COMMENT '订阅开始时间',
    expires_at TIMESTAMP NOT NULL COMMENT '订阅到期时间',

    -- 状态
    status ENUM('active', 'expired', 'cancelled', 'refunded') DEFAULT 'active',
    auto_renew BOOLEAN DEFAULT TRUE COMMENT '是否自动续费',

    -- 支付信息
    payment_method VARCHAR(50) COMMENT '支付方式',
    transaction_id VARCHAR(100) COMMENT '交易ID',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP COMMENT '取消时间',

    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_expires_at (expires_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员订阅表';
```

### 4. 配额使用记录表 (quota_usage)

```sql
CREATE TABLE quota_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 配额类型
    quota_type ENUM('analysis', 'script_generation', 'api_call', 'export') NOT NULL,

    -- 使用信息
    used_count INT DEFAULT 1 COMMENT '使用次数',
    usage_date DATE NOT NULL COMMENT '使用日期',

    -- 元数据
    metadata JSON COMMENT '额外信息(如工具名称、文案风格等)',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_date (user_id, usage_date),
    INDEX idx_user_type_date (user_id, quota_type, usage_date),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='配额使用记录表';
```

### 5. 手机号变更记录表 (phone_change_logs)

```sql
CREATE TABLE phone_change_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    user_id BIGINT NOT NULL COMMENT '用户ID',

    old_phone VARCHAR(20) NOT NULL COMMENT '旧手机号',
    new_phone VARCHAR(20) NOT NULL COMMENT '新手机号',

    -- 验证信息
    old_phone_verified BOOLEAN DEFAULT FALSE COMMENT '旧手机号验证状态',
    new_phone_verified BOOLEAN DEFAULT FALSE COMMENT '新手机号验证状态',

    -- 操作信息
    ip_address VARCHAR(45) COMMENT '操作IP',
    user_agent TEXT COMMENT '用户代理',

    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_old_phone (old_phone),
    INDEX idx_new_phone (new_phone),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='手机号变更记录表';
```

---

## 🎨 前端页面设计

### 1. 登录/注册页面

```
┌─────────────────────────────────────────────────────────┐
│                    ToolScout AI                          │
│                                                          │
│              [Logo]                                      │
│                                                          │
│              🚀 AI驱动的工具分析专家                      │
│                                                          │
│  ┌────────────────────────────────────────────────┐   │
│  │                                                 │   │
│  │  [📱 手机号登录]  [✉️ 邮箱登录]  [🔑 密码登录]  │   │
│  │                                                 │   │
│  │  ┌──────────────────────────────────────┐     │   │
│  │  │ 📱 +86                                │     │   │
│  │  │    ___________________________        │     │   │
│  │  │    请输入手机号                       │     │   │
│  │  └──────────────────────────────────────┘     │   │
│  │                                                 │   │
│  │  ┌──────────────────────────────────────┐     │   │
│  │  │ 🔐 验证码                            │     │   │
│  │  │    _______________  [获取验证码]      │     │   │
│  │  └──────────────────────────────────────┘     │   │
│  │                                                 │   │
│  │         [登录/注册] 按钮                        │   │
│  │                                                 │   │
│  │  ────────────  或  ────────────                │   │
│  │                                                 │   │
│  │    [🔵 Google登录]   [⚫ GitHub登录]          │   │
│  │                                                 │   │
│  │  首次使用第三方登录需绑定手机号                  │   │
│  │                                                 │   │
│  └────────────────────────────────────────────────┘   │
│                                                          │
│  登录即表示同意 [用户协议] 和 [隐私政策]                │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 2. 会员中心页面

```
┌─────────────────────────────────────────────────────────┐
│  会员中心                        [账号设置] [退出登录]   │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  👤 用户信息                                             │
│  ┌────────────────────────────────────────────────┐   │
│  │  [头像]  @username                              │   │
│  │         手机号: 138****1234  [更换]             │   │
│  │         邮箱: user@example.com  [验证]          │   │
│  │                                                 │   │
│  │  当前会员: 🌟 专业版                            │   │
│  │  到期时间: 2025-12-31                          │   │
│  │  [续费] [升级] [管理订阅]                       │   │
│  └────────────────────────────────────────────────┘   │
│                                                          │
│  📊 使用统计                                             │
│  ┌────────────────────────────────────────────────┐   │
│  │  今日已用:                                      │   │
│  │  • 工具分析: 15/无限次                          │   │
│  │  • 文案生成: 42次                              │   │
│  │  • API调用: 523/1000次                        │   │
│  │                                                 │   │
│  │  累计使用:                                      │   │
│  │  • 工具分析: 1,234次                           │   │
│  │  • 文案生成: 3,567次                           │   │
│  │  • 历史记录: 234条 (永久保存)                  │   │
│  └────────────────────────────────────────────────┘   │
│                                                          │
│  💎 会员权益                                             │
│  ┌────────────────────────────────────────────────┐   │
│  │  ✓ 无限次工具分析                               │   │
│  │  ✓ AI深度分析                                  │   │
│  │  ✓ 自定义文案风格                               │   │
│  │  ✓ 历史记录永久保存                             │   │
│  │  ✓ API调用权限 (1000次/月)                     │   │
│  │  ✓ 优先客服支持                                │   │
│  │                                                 │   │
│  │  [查看完整权益对比]                             │   │
│  └────────────────────────────────────────────────┘   │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

---

## 🔐 安全措施

### 1. 密码安全

- **加密算法**: bcrypt (work factor: 12)
- **密码强度要求**:
  - 长度: 8-32字符
  - 必须包含: 大写字母、小写字母、数字
  - 可选: 特殊字符
- **密码存储**: 永不存储明文密码
- **防暴力破解**:
  - 登录失败5次锁定30分钟
  - 使用滑动验证码

### 2. Token管理

- **JWT结构**:
  ```json
  {
    "user_id": 12345,
    "username": "user123",
    "membership_level": "pro",
    "phone": "138****1234",
    "iat": 1699000000,
    "exp": 1699604800
  }
  ```
- **Token有效期**: 7天
- **刷新机制**: 提供refresh token(30天有效)
- **失效处理**:
  - 密码修改后所有token失效
  - 手机号更换后所有token失效
  - 账号被封禁后所有token失效

### 3. OAuth安全

- **CSRF防护**: 使用state参数
- **Token安全**:
  - access_token加密存储
  - refresh_token单独存储
- **绑定验证**: 第三方账号必须绑定手机号才能使用
- **解绑保护**: 必须验证手机号才能解绑OAuth

### 4. 手机验证码安全

- **发送限制**:
  - 同一手机号60秒内只能发送1次
  - 同一手机号每天最多发送5次
  - 同一IP每天最多发送20次
- **验证码规则**:
  - 6位随机数字
  - 有效期60秒
  - 使用后立即失效
- **防刷验证**: 接入滑动验证码或图形验证码

### 5. API安全

- **接口鉴权**: 所有接口需要JWT token
- **签名验证**: 关键接口(支付、会员操作)需要二次签名
- **频率限制**:
  ```
  免费用户: 100次/小时
  基础会员: 500次/小时
  专业会员: 2000次/小时
  企业会员: 10000次/小时
  ```
- **IP白名单**: 管理后台仅允许特定IP访问

---

*文档未完待续,下一部分将详细设计管理员后台系统...*
